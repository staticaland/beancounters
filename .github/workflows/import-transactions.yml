name: Import Transactions

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  import:
    name: Import Bank Transactions
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Install uv
        uses: astral-sh/setup-uv@681c641aba71e4a1c380be3ab5e12ad51f415867 # v7.1.6
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.12

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Run tests
        id: tests
        run: |
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Run tests and capture output
          if uv run python -m pytest tests/ -v --tb=short 2>&1 | tee test_output.txt; then
            echo "✅ **All tests passed!**" >> $GITHUB_STEP_SUMMARY
            echo "test_status=success" >> $GITHUB_OUTPUT
          else
            echo "❌ **Some tests failed**" >> $GITHUB_STEP_SUMMARY
            echo "test_status=failure" >> $GITHUB_OUTPUT
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          # Extract test summary line
          SUMMARY_LINE=$(grep -E "^=+ .* =+$" test_output.txt | tail -1 || echo "")
          if [ -n "$SUMMARY_LINE" ]; then
            # Parse passed/failed counts
            PASSED=$(echo "$SUMMARY_LINE" | grep -oE "[0-9]+ passed" || echo "0 passed")
            FAILED=$(echo "$SUMMARY_LINE" | grep -oE "[0-9]+ failed" || echo "")
            ERRORS=$(echo "$SUMMARY_LINE" | grep -oE "[0-9]+ error" || echo "")
            DURATION=$(echo "$SUMMARY_LINE" | grep -oE "[0-9]+\.[0-9]+s" || echo "")

            echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Passed | $PASSED |" >> $GITHUB_STEP_SUMMARY
            if [ -n "$FAILED" ]; then
              echo "| Failed | $FAILED |" >> $GITHUB_STEP_SUMMARY
            fi
            if [ -n "$ERRORS" ]; then
              echo "| Errors | $ERRORS |" >> $GITHUB_STEP_SUMMARY
            fi
            if [ -n "$DURATION" ]; then
              echo "| Duration | $DURATION |" >> $GITHUB_STEP_SUMMARY
            fi
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          # Show test details in collapsible section
          echo "<details>" >> $GITHUB_STEP_SUMMARY
          echo "<summary>Click to view test details</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat test_output.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Import transactions
        id: import
        run: |
          echo "output<<EOF" >> $GITHUB_OUTPUT
          uv run import-transactions extract data/ 2>&1 || true
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Write summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'SUMMARY_EOF'
          # Transaction Import Results

          This workflow automatically imports bank transactions from the sample data files
          using the Norwegian Beancount importers configured in this project.

          ## Data Sources

          The following bank statement files were processed:

          | Bank | File | Format |
          |------|------|--------|
          | SpareBank1 | `data/sparebank1/transactions.csv` | CSV |
          | DNB Mastercard | `data/dnb/statement.xlsx` | Excel |
          | American Express | `data/amex/activity.qbo` | QBO/OFX |

          ## How It Works

          1. **Beangulp** reads each bank statement file
          2. **Pattern matching** automatically categorizes transactions (e.g., KIWI → Expenses:Groceries)
          3. **Beancount format** output is generated, ready for inclusion in your ledger

          SUMMARY_EOF

      - name: Run demo queries
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'SUMMARY_EOF'

          ---

          SUMMARY_EOF

          ./scripts/run-demo-queries.sh main.beancount >> $GITHUB_STEP_SUMMARY 2>&1 || echo "Demo queries failed" >> $GITHUB_STEP_SUMMARY

      - name: Show imported transactions
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'SUMMARY_EOF'

          ---

          ## Imported Transactions

          <details>
          <summary>Click to expand imported transactions</summary>

          ```beancount
          SUMMARY_EOF

          uv run import-transactions extract data/ >> $GITHUB_STEP_SUMMARY 2>&1 || true

          cat >> $GITHUB_STEP_SUMMARY << 'SUMMARY_EOF'
          ```

          </details>

          ## Next Steps

          To use these transactions in your ledger:
          1. Save the output above to a file in `imports/` (e.g., `imports/2025-02.beancount`)
          2. The main ledger automatically includes all files from `imports/` via `include "imports/*.beancount"`
          3. View your finances with `uv run fava main.beancount`
          SUMMARY_EOF
